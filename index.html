<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Gerador Automático de Horários</title>

  <style>
    * { box-sizing: border-box; font-family: Arial, Helvetica, sans-serif; }
    body { margin: 0; padding: 20px; background: #f4f4f7; }
    h1 { text-align: center; margin-bottom: 10px; }
    .container { max-width: 1300px; margin: 0 auto; }

    .card {
      background: #ffffff;
      padding: 16px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      align-items: end;
    }

    label { font-size: 0.9rem; font-weight: bold; margin-bottom: 4px; display: block; }

    input[type="text"], select {
      width: 100%; padding: 7px 9px;
      border-radius: 6px; border: 1px solid #ccc;
      font-size: 0.9rem;
    }

    button {
      padding: 9px 14px; border-radius: 8px; border: none;
      cursor: pointer; font-size: 0.9rem; font-weight: bold;
      background: #2563eb; color: #fff;
      transition: filter .15s, transform .1s; width: 100%;
    }

    button:hover { filter: brightness(1.08); transform: translateY(-1px); }

    button.secondary { background: #6b7280; }
    button.export { background: #059669; }

    .turmas-box {
      border: 1px solid #d4d4d4;
      border-radius: 6px;
      padding: 6px;
      max-height: 150px;
      overflow-y: auto;
      background: #f9fafb;
    }

    .turma-item {
      display: inline-flex;
      align-items: center;
      margin-right: 10px;
      margin-bottom: 4px;
      font-size: 0.85rem;
    }

    .day-title {
      background: #ffe000; padding: 6px 10px; border-radius: 8px 8px 0 0;
      font-weight: bold; text-align: center; text-transform: uppercase;
      margin-top: 10px;
    }

    table { width: 100%; border-collapse: collapse; background:#fff;
      border-radius: 0 0 8px 8px; overflow:hidden; font-size:.8rem; }

    th,td { border:1px solid #d4d4d4; padding:6px; text-align:center; }

    .time-col { background:#f3f4f6; width:90px; font-weight:bold; }

    .lesson-cell { min-height:40px; padding:3px; border-radius:4px;
      font-size:.75rem; font-weight:bold; color:#111827; }

    /* Cores por professor */
    .color-0 { background:#bfdbfe; }
    .color-1 { background:#fed7aa; }
    .color-2 { background:#bbf7d0; }
    .color-3 { background:#f9a8d4; }
    .color-4 { background:#fee2e2; }
    .color-5 { background:#e9d5ff; }
    .color-6 { background:#fef08a; }
    .color-7 { background:#bae6fd; }
    .color-8 { background:#fecaca; }
    .color-9 { background:#ddd6fe; }

    @media print {
      .no-print { display:none !important; }
      body { background: #ffffff; }
    }
  </style>
</head>

<body>
<div class="container">

  <h1>Gerador Automático de Horários</h1>

  <!-- PAINEL PRINCIPAL -->
  <div class="card no-print">
    <h2>Distribuir professor automaticamente</h2>

    <div class="form-grid">

      <div>
        <label>Professor</label>
        <input type="text" id="autoTeacherInput" placeholder="Nome do professor">
      </div>

      <div>
        <label>Disciplina</label>
        <input type="text" id="autoSubjectInput" placeholder="Ex.: MAT, PORT">
      </div>

      <div>
        <label>Turmas em que leciona</label>
        <div id="turmasCheckboxContainer" class="turmas-box"></div>
      </div>

      <div>
        <label>Nova turma</label>
        <input type="text" id="newClassInput">
        <button id="addClassButton" style="margin-top:4px;">Adicionar turma</button>
      </div>

      <div>
        <label>Dia de hora-atividade</label>
        <select id="autoRestDaySelect"></select>
      </div>

      <div>
        <button id="autoDistributeButton">Distribuir automaticamente</button>
      </div>

      <div>
        <button class="secondary" id="clearButton">Limpar quadro</button>
      </div>

    </div>

    <div class="actions-row">
      <button class="export" id="exportPDF">Exportar PDF</button>
      <button class="export" id="exportXLS">Exportar XLS</button>
    </div>

  </div>

  <!-- QUADRO -->
  <div class="card">
    <h2>Quadro de horários</h2>
    <div id="tablesContainer"></div>
  </div>

</div>

<script>
/* ------------------------------------------------------
   CONFIGURAÇÃO INICIAL
---------------------------------------------------------*/

const days = ["Segunda-feira","Terça-feira","Quarta-feira","Quinta-feira","Sexta-feira"];

const timeSlots = [
  "07:45 - 08:30",
  "08:30 - 09:15",
  "09:15 - 10:00",
  "10:15 - 11:00",
  "11:00 - 11:45"
];

/* TURMAS CONFIRMADAS POR VOCÊ */
let classes = [
  "6º ano 01","6º ano 02","6º ano 03",
  "7º ano 01","7º ano 02",
  "8º ano 01","8º ano 02",
  "9º ano 01","9º ano 02"
];

const timetable = {};

const teacherColorMap = {};
let teacherColorCounter = 0;

const COLOR_CODES = [
  "#bfdbfe","#fed7aa","#bbf7d0","#f9a8d4","#fee2e2",
  "#e9d5ff","#fef08a","#bae6fd","#fecaca","#ddd6fe"
];

const teacherRestDay = {};

/* ------------------------------------------------------
   INICIALIZAÇÃO
---------------------------------------------------------*/

function initTimetable() {
  days.forEach(day => {
    timetable[day] = {};
    timeSlots.forEach(time => {
      timetable[day][time] = {};
      classes.forEach(cls => timetable[day][time][cls] = null);
    });
  });
}

function initDaySelect() {
  let sel = document.getElementById("autoRestDaySelect");
  days.forEach(d => {
    let op = document.createElement("option");
    op.value = d;
    op.textContent = d;
    sel.appendChild(op);
  });
}

function renderClassCheckboxes() {
  const cont = document.getElementById("turmasCheckboxContainer");
  cont.innerHTML = "";
  classes.forEach(cls => {
    let div = document.createElement("label");
    div.className = "turma-item";
    div.innerHTML = `<input type="checkbox" name="turmaDist" value="${cls}" checked> ${cls}`;
    cont.appendChild(div);
  });
}

function getColorIndex(teacher) {
  if (!teacherColorMap[teacher]) {
    teacherColorMap[teacher] = teacherColorCounter % 10;
    teacherColorCounter++;
  }
  return teacherColorMap[teacher];
}

function getColorClass(teacher) {
  return "color-" + getColorIndex(teacher);
}

/* ------------------------------------------------------
   VERIFICAÇÕES
---------------------------------------------------------*/

function teacherBusy(teacher, day, time) {
  // CORRETO: só está ocupado se ELE já tem aula nesse horário
  for (let turma in timetable[day][time]) {
    let aula = timetable[day][time][turma];
    if (aula && aula.teacher === teacher) {
      return true;
    }
  }
  return false;
}

function countSubjectInDay(subject, cls, day) {
  let c = 0;
  timeSlots.forEach(t => {
    const l = timetable[day][t][cls];
    if (l && l.subject.toUpperCase() === subject.toUpperCase()) c++;
  });
  return c;
}

/* ------------------------------------------------------
   ADICIONAR TURMA
---------------------------------------------------------*/

function addClass() {
  let name = document.getElementById("newClassInput").value.trim();
  if (!name) return alert("Digite uma turma.");
  if (classes.includes(name)) return alert("Turma já existe.");

  classes.push(name);

  days.forEach(day => {
    timeSlots.forEach(time => {
      timetable[day][time][name] = null;
    });
  });

  document.getElementById("newClassInput").value = "";
  renderClassCheckboxes();
  renderTables();
}

/* ------------------------------------------------------
   DISTRIBUIÇÃO AUTOMÁTICA
---------------------------------------------------------*/

function autoDistribute() {

  const teacherName = document.getElementById("autoTeacherInput").value.trim();
  const subjectName = document.getElementById("autoSubjectInput").value.trim();
  const restDay = document.getElementById("autoRestDaySelect").value;

  if (!teacherName || !subjectName)
    return alert("Preencha Professor e Disciplina.");

  const teacher = teacherName.toUpperCase();
  const subject = subjectName.toUpperCase();

  teacherRestDay[teacher] = restDay;
  getColorIndex(teacher);

  const selectedClasses = Array.from(
    document.querySelectorAll("input[name='turmaDist']:checked")
  ).map(i => i.value);

  if (selectedClasses.length === 0)
    return alert("Selecione pelo menos uma turma.");

  selectedClasses.forEach(cls => {

    let falta = 99999;

    outer:
    for (let day of days) {

      if (day === restDay) continue;

      for (let time of timeSlots) {

        if (falta <= 0) break outer;

        if (!selectedClasses.includes(cls)) continue;

        if (timetable[day][time][cls] !== null) continue;

        if (teacherBusy(teacher, day, time)) continue;

        if (countSubjectInDay(subject, cls, day) >= 2) continue;

        timetable[day][time][cls] = {
          teacher: teacher,
          subject: subject
        };

        falta--;
      }
    }
  });

  renderTables();
  alert("Distribuição concluída.");
}

/* ------------------------------------------------------
   LIMPAR QUADRO
---------------------------------------------------------*/

function clearAll() {
  if (!confirm("Deseja limpar todo o quadro?")) return;

  initTimetable();

  for (let k in teacherRestDay) delete teacherRestDay[k];
  for (let k in teacherColorMap) delete teacherColorMap[k];
  teacherColorCounter = 0;

  document.getElementById("autoTeacherInput").value = "";
  document.getElementById("autoSubjectInput").value = "";

  renderTables();
}

/* ------------------------------------------------------
   EXPORTAR PDF
---------------------------------------------------------*/

function exportPDF() {
  window.print();
}

/* ------------------------------------------------------
   EXPORTAR XLS
---------------------------------------------------------*/

function exportXLS() {
  let html = `
  <html><head><meta charset="UTF-8">
  <style>
    table { border-collapse: collapse; }
    th, td { border:1px solid #000; padding:4px; text-align:center; }
  </style>
  </head><body>`;

  days.forEach(day => {

    html += `<h3>${day}</h3><table><thead><tr><th>Horário</th>`;

    classes.forEach(cls => html += `<th>${cls}</th>`);
    html += "</tr></thead><tbody>";

    timeSlots.forEach(time => {
      html += `<tr><td>${time}</td>`;

      classes.forEach(cls => {
        const l = timetable[day][time][cls];
        if (!l) {
          html += "<td></td>";
        } else {
          let idx = getColorIndex(l.teacher);
          let bg = COLOR_CODES[idx];
          html += `<td style="background:${bg};font-weight:bold">${l.subject}<br>${l.teacher}</td>`;
        }
      });

      html += "</tr>";
    });

    html += "</tbody></table><br>";

  });

  html += "</body></html>";

  let blob = new Blob([html], { type: "application/vnd.ms-excel" });
  let url = URL.createObjectURL(blob);

  let a = document.createElement("a");
  a.href = url;
  a.download = "horario_escolar.xls";
  a.click();

  URL.revokeObjectURL(url);
}

/* ------------------------------------------------------
   RENDER TABELAS
---------------------------------------------------------*/

function renderTables() {
  const cont = document.getElementById("tablesContainer");
  cont.innerHTML = "";

  days.forEach(day => {

    cont.innerHTML += `<div class="day-title">${day}</div>`;

    let html = `<table><thead><tr><th class="time-col">Horário</th>`;

    classes.forEach(cls => html += `<th>${cls}</th>`);

    html += "</tr></thead><tbody>";

    timeSlots.forEach(time => {

      html += `<tr><td class="time-col">${time}</td>`;

      classes.forEach(cls => {
        const l = timetable[day][time][cls];
        if (!l) html += "<td></td>";
        else html += `<td><div class="lesson-cell ${getColorClass(l.teacher)}">${l.subject}<br>${l.teacher}</div></td>`;
      });

      html += "</tr>";
    });

    html += "</tbody></table>";

    cont.innerHTML += html;

  });
}

/* ------------------------------------------------------
   INICIAR
---------------------------------------------------------*/

initTimetable();
initDaySelect();
renderClassCheckboxes();
renderTables();

document.getElementById("autoDistributeButton").onclick = autoDistribute;
document.getElementById("clearButton").onclick = clearAll;
document.getElementById("exportPDF").onclick = exportPDF;
document.getElementById("exportXLS").onclick = exportXLS;
document.getElementById("addClassButton").onclick = addClass;

</script>

</body>
</html>

